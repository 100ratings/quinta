<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Treino QUINTA</title>
<style>
  :root{--bg:#0f1115;--fg:#e6e6e6;--muted:#9aa3b2;--ok:#19c37d;--err:#ff5c5c;--card:#151923;--accent:#7aa2ff}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:880px;margin:36px auto;padding:0 20px}
  .card{background:var(--card);border:1px solid #202637;border-radius:12px;padding:18px}
  h1{font-size:20px;margin:0 0 8px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .big{font-size:28px;font-weight:700}
  .muted{color:var(--muted)}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid #2a3242;background:#131827;font-size:12px}
  button{background:#1d2433;color:var(--fg);border:1px solid #2a3242;border-radius:10px;padding:11px 14px;font-size:15px;cursor:pointer}
  button:hover{border-color:#3a4760}
  .kbd{font-family:ui-monospace,Consolas,Menlo,monospace;background:#111521;border:1px solid #273047;border-radius:6px;padding:2px 6px;font-size:12px}
  .stats{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
  .stat{background:#121726;border:1px solid #20283a;border-radius:8px;padding:8px 10px;font-size:13px}
  .feedback{margin-top:8px;font-size:16px}
  .ok{color:var(--ok)} .err{color:var(--err)}
  .board{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:12px}
  .item{border:1px solid #2a3242;border-radius:10px;padding:10px;text-align:center}
  .force{outline:2px solid var(--accent)}
  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:8px}
  .seg{display:flex;border:1px solid #2a3242;border-radius:10px;overflow:hidden}
  .seg input{display:none}
  .seg label{padding:9px 12px;cursor:pointer}
  .seg input:checked + label{background:#2a3347}
  .modal{position:fixed;inset:0;display:none;place-items:center;background:#0008;padding:20px}
  .modal .inner{max-width:900px;width:100%;background:#0f121d;border:1px solid #2a3242;border-radius:12px;padding:18px}
  .modal h2{margin:0 0 8px;font-size:18px}
  .legend{font-size:14px;color:var(--muted)}
  .legend b{color:#cfd8ea}
  .hr{height:1px;background:#2a3242;margin:12px 0}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  /* NOVO: caixinha de resultado do modo manual */
  .manualResult{font-size:14px;margin-left:4px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Treino <span class="muted">QUINTA — Mecânica Rápida</span></h1>

    <div class="row" style="margin:6px 0 10px">
      <button id="nextBtn" title="Atalho: N">Gerar número <span class="kbd">N</span></button>
      <button id="checkBtn" title="Atalho: Enter">Verificar <span class="kbd">Enter</span></button>
      <button id="helpBtn" title="Atalho: H">Ajuda <span class="kbd">H</span></button>

      <span class="pill">Intervalo: 
        <select id="range">
          <option value="1-15">1–15 (padrão)</option>
          <option value="15-30">15–30</option>
          <option value="1-30">1–30</option>
          <option value="30-45">30–45</option>
          <option value="45-60">45–60</option>
          <option value="30-60">30–60</option>
          <option value="1-60">1–60</option>
          <option value="custom">Personalizar…</option>
        </select>
      </span>
      <span id="customWrap" class="pill" style="display:none">
        <input id="minN" type="number" value="1" style="width:80px;background:#0d1017;border:1px solid #2a3242;color:#e6e6e6;border-radius:8px;padding:6px"> –
        <input id="maxN" type="number" value="15" style="width:80px;background:#0d1017;border:1px solid #2a3242;color:#e6e6e6;border-radius:8px;padding:6px">
      </span>

      <span class="pill">
        <label><input id="adaptiveCB" type="checkbox" checked style="vertical-align:middle"> Adaptativo</label>
      </span>
      <button id="resetBtn" title="Zerar aprendizado">Resetar treino</button>
    </div>

    <!-- NOVO: modo manual -->
    <div class="row" style="margin:0 0 8px">
      <span class="pill">
        Digitar N:
        <input id="manualN" type="number" inputmode="numeric" placeholder="ex: 33" style="width:90px;margin-left:6px;background:#0d1017;border:1px solid #2a3242;color:#e6e6e6;border-radius:8px;padding:6px">
      </span>
      <button id="analyzeBtn" title="Atalho: Ctrl+Enter">Descobrir lado & tipo</button>
      <span id="manualOut" class="manualResult muted">—</span>
    </div>

    <div class="big" id="number">—</div>
    <div class="legend" id="hint">Gere um número e escolha a contagem e o lado. O item de força é sempre o <b>2º da esquerda</b>.</div>

    <div class="board" aria-label="linha de 5 itens">
      <div class="item">1º</div>
      <div class="item force">2º (força)</div>
      <div class="item">3º</div>
      <div class="item">4º</div>
      <div class="item">5º</div>
    </div>

    <div class="controls">
      <div class="seg" role="radiogroup" aria-label="Tipo de contagem">
        <input id="tBasic" name="tipo" type="radio" checked><label for="tBasic">Basic</label>
        <input id="tBounce" name="tipo" type="radio"><label for="tBounce">Bounce</label>
      </div>
      <div class="seg" role="radiogroup" aria-label="Lado de início">
        <input id="sLeft" name="side" type="radio" checked><label for="sLeft">Esquerda</label>
        <input id="sRight" name="side" type="radio"><label for="sRight">Direita</label>
      </div>
      <span class="pill">Passo-a-passo <input id="step" type="checkbox" style="vertical-align:middle"></span>
    </div>

    <div class="feedback" id="feedback"></div>

    <div class="stats">
      <div class="stat">Acertos: <b id="ok">0</b></div>
      <div class="stat">Erros: <b id="err">0</b></div>
      <div class="stat">Série: <b id="streak">0</b></div>
      <div class="stat">Tempo: <b id="timer">0.0s</b></div>
    </div>
  </div>
</div>

<!-- Modal de ajuda (inalterado) -->
<div class="modal" id="modal">
  <div class="inner">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2>Regras rápidas & lembretes</h2>
      <button id="closeHelp">Fechar</button>
    </div>
    <div class="hr"></div>
    <div class="grid2">
      <div>
        <h3 style="margin:0 0 6px">Coração do método</h3>
        <div class="legend">
          • Força 1 item entre 5; o item de força fica em <b>2º da esquerda</b> (fixo).<br>
          • <b>Tipo:</b> se <b>N é par → Basic</b>; se <b>N é ímpar → Bounce</b>.<br>
          • <b>Lado (Basic):</b> comece pela <b>esquerda</b> se <code>N ≡ 0 ou 2 (mod 8)</code>, senão pela <b>direita</b>.<br>
          • <b>Lado (Bounce):</b> use <b>N+1</b> para a mesma regra acima (e conte <i>movimentos</i>).<br>
          • “Basic” conta <i>pontos</i> 1,2,3,4,5,4,3,2,1…; “Bounce” conta <i>movimentos</i>.
        </div>
        <div class="hr"></div>
        <h3 style="margin:0 0 6px">Garantindo par (opcional)</h3>
        <div class="legend">
          • <b>IBO/DBO</b> (increase/decrease by one).<br>
          • Outros: “tag team”, pareamento/pares, campo de seleção com totais pares etc.
        </div>
      </div>
      <div>
        <h3 style="margin:0 0 6px">Dicas</h3>
        <div class="legend">
          • Atalhos: <span class="kbd">N</span>, <span class="kbd">Enter</span>, <span class="kbd">H</span>.<br>
          • Pense só em <b>N mod 8</b> + <b>paridade</b>.<br>
          • “Bounce” com uma peça andando (ex.: peão) justifica os movimentos.
        </div>
        <div class="hr"></div>
        <h3 style="margin:0 0 6px">Exemplo mental</h3>
        <div class="legend">
          N=22 → Basic; 22 ≡ 6 (mod 8) ⇒ começa <b>Direita</b>.<br>
          N=33 → Bounce; use 34 ⇒ 34 ≡ 2 (mod 8) ⇒ começa <b>Esquerda</b>.
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(()=> {
  // ===== util =====
  const $ = sel => document.querySelector(sel);
  const numberEl = $('#number'), feedback = $('#feedback');
  const okEl=$('#ok'), errEl=$('#err'), streakEl=$('#streak'), timerEl=$('#timer');
  const nextBtn=$('#nextBtn'), checkBtn=$('#checkBtn'), resetBtn=$('#resetBtn');
  const helpBtn=$('#helpBtn'), modal=$('#modal'), closeHelp=$('#closeHelp');
  const tBasic=$('#tBasic'), tBounce=$('#tBounce');
  const sLeft=$('#sLeft'), sRight=$('#sRight');
  const stepCB=$('#step');
  const rangeSel=$('#range'), customWrap=$('#customWrap'), minN=$('#minN'), maxN=$('#maxN');
  const adaptiveCB=$('#adaptiveCB');

  // NOVO: refs do modo manual
  const manualN = $('#manualN');
  const analyzeBtn = $('#analyzeBtn');
  const manualOut = $('#manualOut');

  let N=null, lastN=null, startTime=0, ok=0, err=0, streak=0, locked=false;

  // Pesos por "tipo de caso" (BL, BR, bL, bR)
  let weights = [1,1,1,1];

  function randInt(a,b){return Math.floor(Math.random()*(b-a+1))+a}
  function now(){return performance.now()}
  function updateTimer(){ if(startTime){ timerEl.textContent=((now()-startTime)/1000).toFixed(1)+'s'; } requestAnimationFrame(updateTimer) }
  requestAnimationFrame(updateTimer);

  function currentRange(){
    if(rangeSel.value==='custom'){
      let a=parseInt(minN.value||'1',10), b=parseInt(maxN.value||'15',10);
      if(a>b) [a,b]=[b,a];
      return [Math.max(1,a), Math.min(9999,b)];
    }
    const [a,b]=rangeSel.value.split('-').map(x=>parseInt(x,10)); return [a,b];
  }

  // ===== Regras QUINTA =====
  function correctRule(n){
    const tipo = (n%2===0)? 'basic':'bounce';
    const m = (tipo==='bounce')? n+1 : n;
    const r = ((m%8)+8)%8;
    const lado = (r===0 || r===2)? 'left':'right';
    return {tipo,lado, r, m};
  }
  function bucketFromRule(rule){
    if(rule.tipo==='basic' && rule.lado==='left') return 0;
    if(rule.tipo==='basic' && rule.lado==='right') return 1;
    if(rule.tipo==='bounce' && rule.lado==='left') return 2;
    return 3; // bounce+right
  }

  // ===== Geração de N: sem repetição imediata + viés adaptativo =====
  function sampleBucketAvailable(a, b){
    const seen = new Set();
    for(let i=0;i<400 && seen.size<4;i++){
      seen.add(bucketFromRule(correctRule(randInt(a,b))));
    }
    return seen;
  }

  function pickBucket(a, b){
    const avail = sampleBucketAvailable(a, b);
    const effective = [0,0,0,0];
    let sum=0;
    for(let i=0;i<4;i++){
      if(avail.has(i)){
        effective[i] = adaptiveCB.checked ? Math.max(0.05, weights[i]) : 1;
        sum += effective[i];
      }
    }
    let r = Math.random()*sum;
    for(let i=0;i<4;i++){
      if(!avail.has(i)) continue;
      if(r < effective[i]) return i;
      r -= effective[i];
    }
    for(let i=0;i<4;i++) if(avail.has(i)) return i;
    return 0;
  }

  function newNumber(){
    const [a,b]=currentRange();
    const targetBucket = pickBucket(a,b);

    let candidate = null, tries = 0;
    const MAX_TRIES = 400;
    while(tries++ < MAX_TRIES){
      const x = randInt(a,b);
      if(x === lastN && b>a) continue; // evita repetição imediata
      if(bucketFromRule(correctRule(x)) === targetBucket){ candidate = x; break; }
    }
    if(candidate===null){
      do { candidate = (a===b? a : randInt(a,b)); } while(candidate===lastN && b>a);
    }

    N = candidate;
    lastN = N;

    numberEl.textContent = String(N);
    startTime = now();
    feedback.textContent='';
    locked=false;
  }

  // ===== Simulação / verificação =====
  function simulate(n, tipo, lado, step=false){
    const target=1;
    let pos = (lado==='left')? 0: 4;
    let dir = (lado==='left')? +1 : -1;
    let log=[];
    if(tipo==='basic'){
      let count=0;
      while(count<n){
        count++;
        if(step) log.push({count,pos});
        if(count===n) break;
        pos += dir;
        if(pos===4 || pos===0) dir*=-1;
      }
    }else{
      let moves=0;
      while(moves<n){
        pos += dir; moves++;
        if(step) log.push({count:moves,pos});
        if(pos===4 || pos===0) dir*=-1;
      }
    }
    return {hit:(pos===target), pos, log};
  }

  function userSelection(){
    const tipo = tBasic.checked? 'basic':'bounce';
    const lado = sLeft.checked? 'left':'right';
    return {tipo,lado};
  }

  // ===== Adaptação pelos tempos (FAST ≤3s; SLOW ≥5s) =====
  function resetLearning(){ weights = [1,1,1,1]; }

  function updateAdaptiveWeights(bucket, elapsedSec){
    if(!adaptiveCB.checked) return;
    const SLOW = 5.0, FAST = 3.0;
    const UP = 0.3, DOWN = 0.2;
    const MIN_W = 0.2, MAX_W = 3.0;

    if(elapsedSec >= SLOW){
      weights[bucket] = Math.min(MAX_W, weights[bucket] + UP);
    }else if(elapsedSec <= FAST){
      weights[bucket] = Math.max(MIN_W, weights[bucket] - DOWN);
    }else{
      const toward1 = 0.05;
      weights[bucket] += (1 - weights[bucket]) * toward1;
    }
  }

  function verify(){
    if(locked || N==null) return;
    locked=true;

    const elapsed = (now()-startTime)/1000;
    const ideal = correctRule(N);
    const sel = userSelection();
    const sim  = simulate(N, sel.tipo, sel.lado, stepCB.checked);

    const idealTxt = `${ideal.tipo==='basic'?'Basic':'Bounce'} + ${ideal.lado==='left'?'Esq.':'Dir.'}`;
    const userTxt  = `${sel.tipo==='basic'?'Basic':'Bounce'} + ${sel.lado==='left'?'Esq.':'Dir.'}`;

    const isRight = sim.hit;

    if(isRight){
      ok++; streak++;
      feedback.innerHTML = `<span class="ok">Correto!</span> <span class="muted">(${userTxt}) — ${elapsed.toFixed(1)}s</span>`;
    }else{
      err++; streak=0;
      feedback.innerHTML = `<span class="err">Errou.</span> <span class="muted">Você escolheu ${userTxt}. Ideal: <b>${idealTxt}</b>. — ${elapsed.toFixed(1)}s</span>`;
    }

    if(stepCB.checked && sim.log.length){
      const path = sim.log.map(s=>s.pos+1).join(' → ');
      feedback.innerHTML += `<div class="muted" style="margin-top:6px">Trajeto: ${path}</div>`;
    }

    okEl.textContent=ok; errEl.textContent=err; streakEl.textContent=streak;

    // atualiza aprendizado para o bucket deste N
    const bucket = bucketFromRule(ideal);
    updateAdaptiveWeights(bucket, elapsed);
  }

  // ===== NOVO: análise manual =====
  function analyzeManual(){
    const raw = manualN.value.trim();
    if(!raw){ manualOut.textContent='—'; return; }
    const n = Number(raw);
    if(!Number.isFinite(n) || !Number.isInteger(n) || n<=0){
      manualOut.innerHTML = `<span class="err">Digite um inteiro positivo.</span>`;
      return;
    }
    const rule = correctRule(n);
    // refletir nos botões
    (rule.tipo==='basic'? tBasic : tBounce).checked = true;
    (rule.lado==='left'? sLeft : sRight).checked = true;
    // texto curto
    const tipoTxt = rule.tipo==='basic' ? 'Basic' : 'Bounce';
    const ladoTxt = rule.lado==='left' ? 'Esquerda' : 'Direita';
    manualOut.innerHTML = `<span class="ok">${tipoTxt} + ${ladoTxt}</span> <span class="muted">(N=${n}${rule.tipo==='bounce'?', usa N+1='+(rule.m):''}; mod8=${rule.r})</span>`;
  }

  // ===== events =====
  nextBtn.addEventListener('click', newNumber);
  checkBtn.addEventListener('click', verify);
  helpBtn.addEventListener('click', ()=> modal.style.display='grid');
  closeHelp.addEventListener('click', ()=> modal.style.display='none');
  rangeSel.addEventListener('change', ()=> customWrap.style.display = (rangeSel.value==='custom'?'inline-flex':'none'));
  resetBtn.addEventListener('click', ()=>{
    ok=err=streak=0; okEl.textContent=0; errEl.textContent=0; streakEl.textContent=0;
    lastN=null; feedback.textContent=''; manualOut.textContent='—'; manualN.value='';
    resetLearning();
  });

  // atalhos
  document.addEventListener('keydown', (e)=>{
    const k = e.key.toLowerCase();
    if(k==='n'){ newNumber(); }
    else if(e.key==='Enter' && !e.ctrlKey){ verify(); }      // Enter → verificar número gerado
    else if(e.key==='enter' && e.ctrlKey) { analyzeManual(); } // não funciona assim; fallback abaixo
    else if(k==='h'){ modal.style.display='grid'; }
  });
  // Enter dentro do input manual → analisar
  manualN.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ analyzeManual(); } });
  analyzeBtn.addEventListener('click', analyzeManual);

  // inicial
  resetLearning();
  newNumber();
})();
</script>
</body>
</html>
